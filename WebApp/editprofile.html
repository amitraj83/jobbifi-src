<script src="js/jquery.numeric.js"></script>
<script>
    var editSkillSet = function (skill, year) {
        var askill = '<li>' +
                ' <div class="alert alert-info alert-dismissible" role="alert" style="margin:0px;padding:7px;">' +
                '<button type="button" class="close" data-dismiss="alert" style="position:static">&nbsp;<span aria-hidden="true">&times;</span>' +
                '<span class="sr-only">Delete</span>' +
                '</button>' +
                '<a href="#">' +
                '<span class="badge pull-right" id="sky">' + year + '</span><span id="sk">' + skill + '</span></a>' +
                '</div>' +
                '</li>';
        $("#update_skills").append(askill);
    }

    $(document).ready(function () {

        $("#uploadphotobtn").click(function () {
            $("#uploadphoto").trigger('click');
        });

        $('#uploadphoto').attr({'data-url': "aauth/fileupload.do?type=profilepicupdate&interviewer=" + user.getUserName()});
        $('#uploadphoto').fileupload("destroy");
        $('#uploadphoto').fileupload({
            dataType: 'json',
            maxChunkSize: 20000000,
            done: function (e, data) {
                var jsonResponse = jQuery.parseJSON(data.jqXHR.responseText);
                if (null != jsonResponse)
                    $("#update_img").attr({src: jsonResponse.path});
            },
            add: function (e, data) {
                data.submit();
            }
        });

        $("#update_img").attr("src", user.getProfilePic());
        $("#updatecountries").html(allCountriesOption);
        $("#perhourrate").val(user.getRate());

        var allskills = user.getSkillList();
        for (var i = 0; i < allskills.length; i++) {
            editSkillSet(allskills[i].skill, allskills[i].skillYear);
        }

        $('#update_addskill').click(function () {
            editSkillSet($("#update_skill").val(), $("#update_skillexp").val());
        });

        $("#updatecountries").val(user.getCountry());
        $("#update_shortcv").val(user.getCV());

        var allpositions = user.getPositions();
        var positionHTML = '<div class="form-group" id="positionDiv">' +
                '  <label class="col-lg-3 control-label">Position:</label>' +
                '  <div class="col-lg-9">' +
                '      <div class="row">' +
                '          <div class="col-md-1" style="padding:8px 0px 0px 15px;">Title:</div>' +
                '          <div class="col-md-4" ><input name="title" class="form-control" type="text" value="$title$"></div>' +
                '          <div class="col-md-2" style="padding:8px 0px 0px 1px;">Company:</div>' +
                '          <div class="col-md-4" style="padding:0px 0px 0px 5px;"><input name="companyName" class="form-control" type="text" value="$cn$"></div>' +
                '     </div>  ' +
                '      <div class="row">' +
                '          <div class="col-md-1" style="padding:8px 0px 0px 15px;">Start:</div>' +
                '          <div class="col-md-4" ><input name="startyear" class="form-control" type="text" value="$sy$"></div>' +
                '          <div class="col-md-2" style="padding:8px 0px 0px 1px;">End:</div>' +
                '          <div class="col-md-4" style="padding:0px 0px 0px 5px;"><input name="endyear" class="form-control" type="text" value="$ey$"></div>' +
                '      </div>  ' +
                '      <textarea name="description" rows="3" class="form-control">$desc$</textarea>' +
                '  </div>' +
                '</div>';

        for (var i = 0; i < allpositions.length; i++) {
            var screen = positionHTML.split("$title$").join(allpositions[i].title)
                    .split("$cn$").join(allpositions[i].companyName)
                    .split("$sy$").join(allpositions[i].startyear)
                    .split("$ey$").join(allpositions[i].endyear)
                    .split("$desc$").join(allpositions[i].description);
            $("#update_allpositions").append(screen);
        }

        $(document).on('click', '#update_addmoreposition', function (event) {
            event.preventDefault();
            var screen = positionHTML.split("$title$").join("")
                    .split("$cn$").join("")
                    .split("$sy$").join("")
                    .split("$ey$").join("")
                    .split("$desc$").join("");
            $("#update_allpositions").append(screen);
        });


        var educationHTML = ' <div class="form-group" id="edudiv"><label class="col-lg-3 control-label">Education:</label>' +
                '<div class="col-lg-9">' +
                '   <table style="padding:5px">' +
                '     <tr>' +
                '           <td>Degree:</td>' +
                '           <td><input name="degree" class="form-control" type="text" value="$degree$"></td>' +
                '           <td>Major:</td>' +
                '           <td><input name="major" class="form-control" type="text" value="$major$"></td>' +
                '     </tr>' +
                '     <tr>' +
                '          <td>University:</td>' +
                '           <td colspan="3"><input name="university" class="form-control" type="text" value="$uni$"> </td>' +
                '     </tr>' +
                '     <tr>' +
                '           <td>Start:</td>' +
                '           <td><input name="startyear" class="form-control" type="text" value="$sy$"></td>' +
                '           <td>End:</td>' +
                '           <td><input name="endyear" class="form-control" type="text" value="$ey$"></td>' +
                '     </tr>' +
                '     ' +
                '   </table>' +
                '  </div>' +
                '</div>';


        var alleducations = user.getEducations();
        for (var i = 0; i < alleducations.length; i++) {
            var screen = educationHTML.split("$degree$").join(alleducations[i].degree)
                    .split("$major$").join(alleducations[i].fos)
                    .split("$uni$").join(alleducations[i].school)
                    .split("$sy$").join(alleducations[i].sy)
                    .split("$ey$").join(alleducations[i].ey);
            $("#update_alleducations").append(screen);
        }

        $(document).on('click', '#update_addmoreeducation', function (event) {
            event.preventDefault();
            var screen = educationHTML.split("$degree$").join("")
                    .split("$major$").join("")
                    .split("$uni$").join("")
                    .split("$sy$").join("")
                    .split("$ey$").join("");
            $("#update_alleducations").append(screen);
        });

        $("#perhourrate").numeric();

// edit profile
        $('#edit_profile_button').click(function () {
            var param = "";
            var country = $("#updatecountries").val();
            param += "country=" + country;

            var skills = new Array();
            var skill_li = $("#update_skills").find("li > div.alert");
            for (var i = 0; i < skill_li.length; i++) {
                var li = skill_li[i];
                var skill = {};
                skill.skill = $(li).find("#sk").text();
                skill.skillYear = $(li).find("#sky").text();
                skills.push(skill);
            }
            param += "&skills=" + JSON.stringify(skills);
            param += "&rate=" + $("#perhourrate").val();
            param += "&cv=" + $("#update_shortcv").val();

            var edudiv = $("#update_alleducations").children("#edudiv");
            var educations = new Array();
            for (var i = 0; i < edudiv.length; i++) {
                var adiv = edudiv[i];
                var inputs = $(adiv).find("input");
                var edu = {};
                edu.degree = $(inputs[0]).val();
                edu.fieldOfStudy = $(inputs[1]).val();
                edu.schoolname = $(inputs[2]).val();
                edu.startYear = $(inputs[3]).val();
                edu.endYear = $(inputs[4]).val();
                educations.push(edu);
            }
            param += "&educations=" + JSON.stringify(educations);

            var positiondivs = $("#update_allpositions").children("#positionDiv");
            var positions = new Array();
            for (var i = 0; i < positiondivs.length; i++) {
                var adiv = positiondivs[i];
                var position = {};
                position.title = $(adiv).find("input[name='title']").val();
                position.companyName = $(adiv).find("input[name='companyName']").val();
                position.startYear = $(adiv).find("input[name='startyear']").val();
                position.endYear = $(adiv).find("input[name='endyear']").val();
                position.description = $(adiv).find("textarea[name='description']").val();
                positions.push(position);
            }
            param += "&positions=" + JSON.stringify(positions);

            $.ajax({
                type: "GET",
                url: BASE_URL + "updateprofile.do",
                data: param
            }).done(function (msg) {
                var resData = jQuery.parseJSON(msg);
                if (resData.status == 1) {
                    //user.setSkills(new_skills);
                    //user.setCompanies(new_companies);
                    //user.setRate($.trim($("#perhourrate").val()));
                    //user.setCV($("#updatedcv").val());
                    //user.setCountry($("#country").val());

                    // the profile is updated but the problem is that
                    // new educations, positions, skills are created with the
                    // new id

                    //alert("Your profile has been updated successfully.");
                    $("#buttonPanel").prepend("<span class='label label-success'>Your profile has been updated successfully.</span>");


                } else {
                    alert("Your profile could't update, please try again.");
                }
            });

        });
    });
</script>

<h3 style="margin:0px">Edit Your Profile</h3>
<hr>
<div class="row">
    <div class="col-md-12">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Update Your Profile Picture</h3>
            </div>
            <div class="panel-body">
                <div class="row">
                    <div class="col-md-3">
                        <img src="http://placehold.it/150" id="update_img" class="avatar img-square" alt="avatar"
                             width="150px" height="150px">
                    </div>
                    <div class="col-md-5">
                        <br><br><br><br><br>
                        <input id="uploadphoto" type="file" name="file"
                               data-url="aauth/fileupload.do?type=profilepicupdate"
                               style="opacity:0;  filter:alpha(opacity: 0);">

                        <div>
                            <button type="button" id="uploadphotobtn" class="btn btn-sm btn-default">Upload Photo
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">General Information</h3>
            </div>
            <div class="panel-body">
                <form class="form-horizontal" role="form">
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Rate(per hour):</label>

                        <div class="col-lg-9">
                            <div class="input-group">
                                <span class="input-group-addon">$</span>
                                <input type="text" id="perhourrate" class="form-control">
                            </div>


                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Present Country:</label>

                        <div class="col-lg-9">
                            <select class="form-control" id="updatecountries"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Skills:</label>

                        <div class="col-lg-9">
                            <div class="row">
                                <div class="col-md-2" style="padding:8px 0px 0px 15px;">Skill Name:</div>
                                <div class="col-md-4" style="padding:2px"><input id="update_skill" style="width:170px;"
                                                                                 class="form-control" type="text"
                                                                                 value="" placeholder="Skill"></div>
                                <div class="col-md-2" style="padding:8px 0px 0px 10px;">Experience:</div>
                                <div class="col-md-2" style="padding:2px 0px 0px 5px;"><select id="update_skillexp"
                                                                                               style="width:90px;"
                                                                                               class="form-control">
                                    <option value="0">0 years</option>
                                    <option value="1">1 years</option>
                                    <option value="2">2 years</option>
                                    <option value="3">3 years</option>
                                    <option value="4">4 years</option>
                                    <option value="5">5 years</option>
                                    <option value="6">6 years</option>
                                    <option value="7">7 years</option>
                                    <option value="8">8 years</option>
                                    <option value="9">9 years</option>
                                    <option value="10">10 years</option>
                                    <option value="11">11 years</option>
                                    <option value="12">12 years</option>
                                    <option value="13">13 years</option>
                                    <option value="14">14 years</option>
                                    <option value="15">15 years</option>
                                    <option value="16">16 years</option>
                                    <option value="17">17 years</option>
                                    <option value="18">18 years</option>
                                    <option value="19">19 years</option>
                                    <option value="20">20 years</option>
                                </select>
                                </div>
                                <div class="col-md-2" style="padding:2px">
                                    <button type="button" class="btn btn-success " id="update_addskill">Add</button>
                                </div>
                            </div>
                            <ul class="nav nav-pills" id="update_skills">

                            </ul>

                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-lg-3 control-label">Short CV:</label>

                        <div class="col-lg-9">
                            <textarea rows="3" class="form-control" id="update_shortcv"></textarea>
                        </div>
                    </div>
                </form>
            </div>
        </div>


        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Update Your Professional Details</h3>
            </div>
            <div class="panel-body">
                <form class="form-horizontal" role="form" id="update_allpositions">

                </form>
                <a href="#" class="pull-right" id="update_addmoreposition">Add More Position</a>
            </div>
        </div>

        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Update Your Education Details</h3>
            </div>
            <div class="panel-body">
                <form class="form-horizontal" role="form" id="update_alleducations">


                </form>
                <a href="#" class="pull-right" id="update_addmoreeducation">Add More Education</a>
            </div>
        </div>
        <center id="buttonPanel">
            <button type="button" class="btn btn-success" id="edit_profile_button">Update Details</button>
            &nbsp;&nbsp;&nbsp;
            <button type="button" class="btn btn-danger">Cancel</button>
        </center>
    </div>
</div>

<hr>