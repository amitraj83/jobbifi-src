function on_message(e){var t=Strophe.getBareJidFromJid($(e).attr("from")),n=$(e).find("html > body"),o=$(e).find("composing");if(o.length>0&&$("#typingplace").html(Strophe.getNodeFromJid(t)+" is typing..."),0===n.length)n=$(e).find("body"),n=n.length>0?n.text():null;else{n=n.contents();var s=$("<span></span>");n.each(function(){document.importNode?$(document.importNode(this,!0)).appendTo(s):s.append(this.xml)})}if(n){var i=getChatMessageWithHTML(friendsprofilepics[Strophe.getNodeFromJid(t)],Strophe.getNodeFromJid(t),(new Date).getTime(),n);$("#mCSB_1_container").append(i),$("#scrollarea").mCustomScrollbar("scrollTo","bottom"),$("#typingplace").html("")}return!0}function on_presence(e){var t=$(e).attr("type"),n=$(e).attr("from"),o="";if(o=n.indexOf("/")>-1?n.split("/")[0]:n,"subscribe"==t){var s=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});connection.sendIQ(s,function(e){var t=!1;$(e).find("item").each(function(){var e=$(this).attr("jid");e.indexOf("/")>-1&&(e=e.split("/")[0]),e==o&&(t=!0)}),0==t&&connection.send($pres({to:o,type:"subscribe"}))}),connection.send($pres({to:n,type:"subscribed"}))}if(user.getUserName()!=o.split("@")[0]){if("unavailable"===t)CHAT_FRIENDS_MAP.put(o.split("@")[0],offlineStatus);else{var i=$(e).find("show").text();""===i||"chat"===i?CHAT_FRIENDS_MAP.put(o.split("@")[0],onlineStatus):CHAT_FRIENDS_MAP.put(o.split("@")[0],onlineStatus)}$("#"+o.split("@")[0]+"_status_img").html(CHAT_FRIENDS_MAP.get(o.split("@")[0]))}return!0}function checkWhetherUserIsOnline(e){var t=CHAT_FRIENDS_MAP.get(e);return-1!=t.indexOf("green")?!0:!1}function populatesFrieldList(){if(0==chatConnected)return void setTimeout(populatesFrieldList,500);for(var e="",t=0;t++<CHAT_FRIENDS_MAP.size;CHAT_FRIENDS_MAP.next())e+=CHAT_FRIENDS_MAP.key()+"$$";$.ajax({type:"GET",url:BASE_URL+"usersdataforinbox.do",data:"userslist="+e}).done(function(e){var t=jQuery.parseJSON(e);friendsprofilepics=t.picmap;for(var n="",o=0;o++<CHAT_FRIENDS_MAP.size;CHAT_FRIENDS_MAP.next()){var s=CHAT_FRIENDS_MAP.key(),i=CHAT_FRIENDS_MAP.value(),a='<div class="list-group-item contactitem cfli" ><div class="row"><div class="col-md-4"><img src="'+t.picmap[s]+'" alt="Scott Stevens" class="img-responsive" /></div><div class="col-md-7" ><div class="row"><a href="#" style="margin-left:3px;">'+s+'<span id="'+s+'_status_img" class="pull-left">'+i+'</span></a></div><div class="row"><small>Bye</small></div></div></div></div>';n+=a,CHAT_FRIENDS_LI.put(s,a)}$("#inboxcontactlist").html(n)})}function saveChatMessage(e,t,n){var o=new Date,s="OFFLINE";checkWhetherUserIsOnline(n)&&(s="ONLINE"),$.ajax({type:"GET",url:BASE_URL+"savechatmessage.do",data:"from="+t+"&to="+n+"&time="+o.getTime()+"&message="+e+"&type="+s}).done(function(e){console.log(e)})}function on_roster(e){$(e).find("query");return friendlist=new Array,$(e).find("item").each(function(){var e=$(this).attr("jid");CHAT_FRIENDS_MAP.put(e.split("@")[0],offlineStatus)}),connection.addHandler(on_presence,null,"presence"),connection.send($pres()),chatConnected=!0,!0}function onConnect(e){if(e==Strophe.Status.CONNECTING)console.log("Strophe is connecting.");else if(e==Strophe.Status.CONNFAIL)console.log("Strophe failed to connect.");else if(e==Strophe.Status.DISCONNECTING)console.log("Strophe is disconnecting.");else if(e==Strophe.Status.DISCONNECTED)console.log("Strophe is disconnected."),console.log("Disconnected:"+connection.jid);else if(e==Strophe.Status.CONNECTED){console.log("Strophe is connected.");var t=$iq({type:"get"}).c("query",{xmlns:"jabber:iq:roster"});connection.sendIQ(t,on_roster),connection.addHandler(on_message,null,"message","chat")}}function signInOnChat(){connection=new Strophe.Connection(BOSH_SERVICE),connection.connect(user.getUserName()+"@"+XMPPService,user.getChatPass(),onConnect)}function signOutOnChat(){null!=connection&&(connection.options.sync=!0,connection.flush(),connection.disconnect())}function showMessageBox(){$("#scrollarea").mCustomScrollbar("scrollTo","bottom"),populatesFrieldList(),$("#chatbox").attr("disabled",!0),$(document).on("keyup","#contactsearch",function(e){$("#inboxcontactlist").html("");for(var t="",n=0;n++<CHAT_FRIENDS_LI.size;CHAT_FRIENDS_LI.next()){var o=CHAT_FRIENDS_LI.key(),s=CHAT_FRIENDS_LI.value();null!=o.match($(this).val())&&(t+=s)}$("#inboxcontactlist").html(t)})}var chatConnected=!1,friendsprofilepics="",CHAT_FRIENDS_LI=new Map,onlineStatus='<img src="images/green.png" width="15px" height="15px" />',offlineStatus='<img src="images/red.png" width="15px" height="15px" />',getChatMessageWithHTML=function(e,t,n,o){var s='<li class="left "><span class="chat-img pull-left"><img src="'+e+'" alt="User Avatar" width="40px" height="40px"/></span><div class="chat-body clearfix">   <div class="header">        <strong class="primary-font">'+t+'</strong> <small class="pull-right text-muted">            <span class="glyphicon glyphicon-time"></span>'+prettyDate(new Date(Number(n)))+"</small>    </div>    <p>"+o+"</p></div></li>";return s};$(document).on("keypress","#chatbox",function(e){if(13==e.which){var t=$msg({to:$.trim($(".cfli.selected").find("a").text())+"@"+XMPPService,type:"chat"}).c("body").t($("#chatbox").get(0).value).up().c("active",{xmlns:"http://jabber.org/protocol/chatstates"});connection.sendIQ(t),$(this).parent().data("composing",!1);var n=getChatMessageWithHTML(user.getProfilePic(),user.getUserName(),(new Date).getTime(),$("#chatbox").val());$("#mCSB_1_container").append(n),saveChatMessage($("#chatbox").val(),user.getUserName(),$.trim($(".cfli.selected").find("a").text())),$("#chatbox").val(""),$("#scrollarea").mCustomScrollbar("scrollTo","bottom")}else{var o=$(this).parent().data("composing");if(!o){console.log($.trim($(".cfli.selected").find("a").text())+"@"+XMPPService);var s=$msg({to:$.trim($(".cfli.selected").find("a").text())+"@"+XMPPService,type:"chat"}).c("composing",{xmlns:"http://jabber.org/protocol/chatstates"});connection.send(s),$(this).parent().data("composing",!0)}}}),$(document).on("click",".cfli",function(){$(".cfli").removeClass("selected"),$(this).addClass("selected"),$("#chatbox").attr("disabled",!1),$("#chatbox").attr("placeholder","Type your message here...");var e=$(this).find("a").text(),t=$(this).find("img").attr("src");$("#chattingwith").html(e),$.ajax({type:"GET",url:BASE_URL+"chathistory.do",data:"user="+user.getUserName()+"&otheruser="+e}).done(function(e){for(var n=jQuery.parseJSON(e),o="",s=0;s<n.data.length;s++){var i=n.data[s].from==user.getUserName()?user.getProfilePic():t,a=getChatMessageWithHTML(i,n.data[s].from,n.data[s].time,n.data[s].message);o+=a}$("#mCSB_1_container").html(o),$("#scrollarea").mCustomScrollbar("scrollTo","bottom")})});